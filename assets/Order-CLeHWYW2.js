import{u as H,s as Q,b as r,f as G,m as J,B as K,h as l,i as a,n as i,k as _,j as u,t as s,C as X,D as Y,a as F,F as A,x as B,l as D,w as Z,q,o as d,z as x,A as aa}from"./index-wd-hZkLN.js";import{k as ea,l as sa,m as ta,i as N,s as oa,n as na,o as da}from"./user-DW6XJAw8.js";import{_ as la}from"./_plugin-vue_export-helper-_GT-bmI3.js";import{C as ra}from"./credit-card-Ww-gscEY.js";import{R as O}from"./refresh-cw-D9FHN0vg.js";import{c as V}from"./createLucideIcon-BcaHDl5-.js";import{W as ia}from"./wallet-GOIk5dMK.js";/**
 * @license lucide-vue-next v0.562.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ca=V("info",[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["path",{d:"M12 16v-4",key:"1dtifu"}],["path",{d:"M12 8h.01",key:"e9boi3"}]]);/**
 * @license lucide-vue-next v0.562.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ua=V("tag",[["path",{d:"M12.586 2.586A2 2 0 0 0 11.172 2H4a2 2 0 0 0-2 2v7.172a2 2 0 0 0 .586 1.414l8.704 8.704a2.426 2.426 0 0 0 3.42 0l6.58-6.58a2.426 2.426 0 0 0 0-3.42z",key:"vktsd0"}],["circle",{cx:"7.5",cy:"7.5",r:".5",fill:"currentColor",key:"kqv944"}]]),pa={class:"dark-tech-order animate-fade-in"},_a={class:"page-header"},ha={class:"header-icon"},va={key:0,class:"order-container"},ya={class:"order-main"},ma={class:"order-card glass-card"},fa={class:"card-header"},ba={class:"trade-no"},ka={class:"order-items"},ga={class:"order-item"},Ca={class:"item-info"},$a={class:"item-name"},wa={class:"item-period"},za={class:"item-price"},Pa={key:0,class:"order-coupon-input-section"},qa={class:"coupon-field"},Ma=["placeholder","disabled"],Sa=["disabled"],Ta={key:1,class:"order-coupon"},Fa={class:"coupon-info"},Oa={class:"coupon-amount"},Ia={class:"order-total"},Ra={class:"total-amount"},Aa={class:"payment-card glass-card"},Ba={class:"card-header"},Da={class:"payment-methods"},Na=["onClick"],Va={class:"method-icon"},Wa=["src"],La={class:"method-info"},Ua={class:"method-name"},ja={key:0,class:"method-fee"},Ea={class:"payment-footer"},Ha=["disabled"],Qa={key:1},Ga={key:2},Ja=["disabled"],Ka={class:"order-sidebar"},Xa={class:"tips-card glass-card"},Ya={class:"card-header"},Za={class:"tips-list"},xa={key:1,class:"loading-state"},ae={key:2,class:"error-state"},ee={class:"pay-modal-content"},se={class:"qr-container"},te={key:0,class:"qr-code-box"},oe={class:"qr-code"},ne={key:0,class:"pay-link-box mt-4"},de={class:"mt-2 text-xs text-secondary"},le=["href"],re={key:1,class:"pay-link-box"},ie=["href"],ce={class:"pay-status"},ue={__name:"Order",setup(pe){const I=Q(),h=J(),{t:v,tm:_e}=H(),c=I.params.trade_no||I.query.trade_no,k=r(!0),y=r(!1),o=r(null),$=r([]),m=r(null),M=r(""),w=r(!1),p=r({type:0,data:""}),S=r(!1),f=r(""),g=r(!1);let z=null;const W=e=>v(`dashboard.plans.cycles.${e}`);G(async()=>{var e,t,P;if(!c){k.value=!1,M.value=v("dashboard.order.invalid");return}try{const[b,C]=await Promise.all([ea({trade_no:c}),sa()]);b.data&&(o.value=b.data),C.data&&($.value=C.data,$.value.length>0&&(m.value=$.value[0].id)),o.value&&(o.value.status===1||o.value.status===3)&&h.replace({name:"PaymentSuccess",query:{trade_no:c,plan_name:(e=o.value.plan)==null?void 0:e.name,amount:o.value.total_amount}})}catch(b){M.value=((P=(t=b.response)==null?void 0:t.data)==null?void 0:P.message)||"加载订单失败"}finally{k.value=!1}});const L=async()=>{var e;if(m.value){y.value=!0;try{const t=await na({trade_no:c,method:m.value});if(t.type===-1){q.success(v("dashboard.order.paySuccess")),h.push({name:"PaymentSuccess",query:{trade_no:c,plan_name:(e=o.value.plan)==null?void 0:e.name,amount:o.value.total_amount}});return}if(t.type===0||t.data&&(t.data.startsWith("http://")||t.data.startsWith("https://"))){window.location.href=t.data;return}p.value={type:t.type,data:t.data},w.value=!0,U()}catch{}finally{y.value=!1}}},U=()=>{S.value=!0,z=setInterval(async()=>{var e;try{const t=await da({trade_no:c});(t.data===1||t.data===3)&&(T(),w.value=!1,q.success(v("dashboard.order.paySuccess")),h.push({name:"PaymentSuccess",query:{trade_no:c,plan_name:(e=o.value.plan)==null?void 0:e.name,amount:o.value.total_amount}}))}catch{}},3e3)},T=()=>{z&&(clearInterval(z),z=null),S.value=!1},j=async()=>{try{await N({trade_no:c}),q.success(v("dashboard.orders.cancelledMessage")),h.push("/plans")}catch{}},E=async()=>{if(f.value){g.value=!0;try{await ta({code:f.value,plan_id:o.value.plan_id,period:o.value.period}),await N({trade_no:c});const e=await oa({plan_id:o.value.plan_id,period:o.value.period,coupon_code:f.value});e.data&&(q.success(v("dashboard.order.couponApplied","优惠码已应用")),h.push({path:"/order",query:{trade_no:e.data}}).then(()=>{window.location.reload()}))}catch{}finally{g.value=!1}}};return K(()=>{T()}),(e,t)=>{var C;const P=D("a-spin"),b=D("a-modal");return d(),l("div",pa,[a("div",_a,[a("div",ha,[_(u(ra),{size:32})]),a("h1",null,s(e.$t("dashboard.order.title")),1),a("p",null,s(e.$t("dashboard.order.description")),1)]),!k.value&&o.value?(d(),l("div",va,[a("div",ya,[a("div",ma,[a("div",fa,[a("h3",null,s(e.$t("dashboard.order.detailTitle")),1),a("span",ba,"#"+s(o.value.trade_no),1)]),a("div",ka,[a("div",ga,[a("div",Ca,[a("span",$a,s((C=o.value.plan)==null?void 0:C.name),1),a("span",wa,s(W(o.value.period)),1)]),a("div",za,"¥"+s((o.value.total_amount/100).toFixed(2)),1)])]),o.value.coupon_id?i("",!0):(d(),l("div",Pa,[a("div",qa,[X(a("input",{type:"text","onUpdate:modelValue":t[0]||(t[0]=n=>f.value=n),placeholder:e.$t("dashboard.order.couponPlaceholder"),class:"coupon-input",disabled:g.value},null,8,Ma),[[Y,f.value]]),a("button",{class:"apply-coupon-btn",onClick:E,disabled:!f.value||g.value},[g.value?(d(),F(u(O),{key:0,class:"animate-spin",size:16})):i("",!0),a("span",null,s(e.$t("dashboard.order.applyCoupon")),1)],8,Sa)])])),o.value.coupon_id?(d(),l("div",Ta,[a("div",Fa,[_(u(ua),{size:16}),a("span",null,s(e.$t("dashboard.order.coupon")),1)]),a("div",Oa,"-¥"+s((o.value.discount_amount/100).toFixed(2)),1)])):i("",!0),a("div",Ia,[a("span",null,s(e.$t("dashboard.order.total")),1),a("span",Ra,"¥"+s((o.value.total_amount/100).toFixed(2)),1)])]),a("div",Aa,[a("div",Ba,[a("h3",null,s(e.$t("dashboard.order.paymentTitle")),1)]),a("div",Da,[(d(!0),l(A,null,B($.value,n=>(d(),l("div",{key:n.id,class:x(["payment-item",{active:m.value===n.id}]),onClick:R=>m.value=n.id},[a("div",Va,[n.icon?(d(),l("img",{key:0,src:n.icon,alt:"icon"},null,8,Wa)):(d(),F(u(ia),{key:1,size:24}))]),a("div",La,[a("span",Ua,s(n.name),1),n.handling_fee_percent||n.handling_fee_fixed?(d(),l("span",ja,s(e.$t("dashboard.order.fee"))+": "+s(n.handling_fee_percent?n.handling_fee_percent+"%":"")+" "+s(n.handling_fee_fixed?"¥"+(n.handling_fee_fixed/100).toFixed(2):""),1)):i("",!0)]),t[3]||(t[3]=a("div",{class:"check-mark"},[a("div",{class:"outer"},[a("div",{class:"inner"})])],-1))],10,Na))),128))]),a("div",Ea,[a("button",{class:"pay-btn",disabled:!m.value||y.value,onClick:L},[y.value?(d(),F(u(O),{key:0,class:"animate-spin",size:20})):i("",!0),y.value?(d(),l("span",Qa,s(e.$t("dashboard.order.paying")),1)):(d(),l("span",Ga,s(e.$t("dashboard.order.payNow")),1))],8,Ha),a("button",{class:"cancel-btn",onClick:j,disabled:y.value},s(e.$t("dashboard.order.cancel")),9,Ja)])])]),a("div",Ka,[a("div",Xa,[a("div",Ya,[_(u(ca),{size:18}),a("h3",null,s(e.$t("dashboard.order.tipsTitle")),1)]),a("ul",Za,[(d(!0),l(A,null,B(e.$tm("dashboard.order.tips"),(n,R)=>(d(),l("li",{key:R},s(n),1))),128))])])])])):i("",!0),k.value?(d(),l("div",xa,[_(P,{size:"large"}),a("p",null,s(e.$t("common.loading")),1)])):i("",!0),!k.value&&!o.value?(d(),l("div",ae,[t[4]||(t[4]=a("div",{class:"error-icon"},"⚠️",-1)),a("p",null,s(M.value||e.$t("dashboard.order.notFound")),1),a("button",{class:"back-link",onClick:t[1]||(t[1]=n=>u(h).push("/plans"))},s(e.$t("dashboard.plans.title")),1)])):i("",!0),_(b,{open:w.value,"onUpdate:open":t[2]||(t[2]=n=>w.value=n),footer:null,closable:!S.value,onCancel:T,centered:"",class:"pay-modal"},{default:Z(()=>{var n;return[a("div",ee,[a("h3",null,s(e.$t("dashboard.order.scanTitle")),1),a("div",se,[p.value.type===1?(d(),l("div",te,[a("div",oe,[_(u(aa),{value:p.value.data,size:200,color:"#3b82f6"},null,8,["value"])]),(n=p.value.data)!=null&&n.startsWith("http")?(d(),l("div",ne,[a("p",de,s(e.$t("dashboard.order.cannotScanTip")),1),a("a",{href:p.value.data,target:"_blank",class:"pay-link-btn"},s(e.$t("dashboard.order.goToPay")),9,le)])):i("",!0)])):p.value.type===0?(d(),l("div",re,[a("p",null,s(e.$t("dashboard.order.jumpPay")),1),a("a",{href:p.value.data,target:"_blank",class:"pay-link-btn"},s(e.$t("dashboard.order.goToPay")),9,ie)])):i("",!0)]),a("div",ce,[_(u(O),{class:"animate-spin",size:16}),a("span",null,s(e.$t("dashboard.order.waiting")),1)])])]}),_:1},8,["open","closable"])])}}},ge=la(ue,[["__scopeId","data-v-977bfbf5"]]);export{ge as default};
