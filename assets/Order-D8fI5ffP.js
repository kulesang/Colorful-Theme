import{u as H,v as Q,r,o as G,z as J,c as l,b as a,k as i,e as h,d as c,t as s,B as K,C as X,j as q,F as R,x as A,f as B,h as Y,w as Z,m as M,i as n,y as x,A as aa}from"./index-DBj0bk-v.js";import{k as ea,l as sa,m as ta,j as N,s as oa,n as na,o as da}from"./user-DXsAa-Hk.js";import{_ as la}from"./_plugin-vue_export-helper-tGYcrXWe.js";import{C as ra}from"./credit-card-BWt1J3HY.js";import{R as F}from"./refresh-cw-BgTXoq3M.js";import{c as V}from"./createLucideIcon-CI9fqIqV.js";import{W as ia}from"./wallet-BG4iNKm9.js";/**
 * @license lucide-vue-next v0.562.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ca=V("info",[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["path",{d:"M12 16v-4",key:"1dtifu"}],["path",{d:"M12 8h.01",key:"e9boi3"}]]);/**
 * @license lucide-vue-next v0.562.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ua=V("tag",[["path",{d:"M12.586 2.586A2 2 0 0 0 11.172 2H4a2 2 0 0 0-2 2v7.172a2 2 0 0 0 .586 1.414l8.704 8.704a2.426 2.426 0 0 0 3.42 0l6.58-6.58a2.426 2.426 0 0 0 0-3.42z",key:"vktsd0"}],["circle",{cx:"7.5",cy:"7.5",r:".5",fill:"currentColor",key:"kqv944"}]]),pa={class:"dark-tech-order animate-fade-in"},ha={class:"page-header"},_a={class:"header-icon"},va={key:0,class:"order-container"},ya={class:"order-main"},ma={class:"order-card glass-card"},fa={class:"card-header"},ba={class:"trade-no"},ka={class:"order-items"},ga={class:"order-item"},Ca={class:"item-info"},$a={class:"item-name"},wa={class:"item-period"},za={class:"item-price"},Ma={key:0,class:"order-coupon-input-section"},Pa={class:"coupon-field"},Ta=["placeholder","disabled"],Sa=["disabled"],qa={key:1,class:"order-coupon"},Fa={class:"coupon-info"},Oa={class:"coupon-amount"},Ia={class:"order-total"},Ra={class:"total-amount"},Aa={class:"payment-card glass-card"},Ba={class:"card-header"},Na={class:"payment-methods"},Va=["onClick"],Wa={class:"method-icon"},Da=["src"],ja={class:"method-info"},La={class:"method-name"},Ua={key:0,class:"method-fee"},Ea={class:"payment-footer"},Ha=["disabled"],Qa={key:1},Ga={key:2},Ja=["disabled"],Ka={class:"order-sidebar"},Xa={class:"tips-card glass-card"},Ya={class:"card-header"},Za={class:"tips-list"},xa={key:1,class:"loading-state"},ae={key:2,class:"error-state"},ee={class:"pay-modal-content"},se={class:"qr-container"},te={key:0,class:"qr-code-box"},oe={class:"qr-code"},ne={key:0,class:"pay-link-box mt-4"},de={class:"mt-2 text-xs text-secondary"},le=["href"],re={key:1,class:"pay-link-box"},ie=["href"],ce={class:"pay-status"},ue={__name:"Order",setup(pe){const W=Q(),b=Y(),{t:_,tm:he}=H(),u=W.query.trade_no,k=r(!0),v=r(!1),d=r(null),C=r([]),y=r(null),P=r(""),$=r(!1),p=r({type:0,data:""}),T=r(!1),m=r(""),g=r(!1);let w=null;const D=e=>_(`dashboard.plans.cycles.${e}`);G(async()=>{var e,t;if(!u){k.value=!1,P.value=_("dashboard.order.invalid");return}try{const[f,z]=await Promise.all([ea({trade_no:u}),sa()]);f.data&&(d.value=f.data),z.data&&(C.value=z.data,C.value.length>0&&(y.value=C.value[0].id))}catch(f){P.value=((t=(e=f.response)==null?void 0:e.data)==null?void 0:t.message)||"加载订单失败"}finally{k.value=!1}});const j=async()=>{var e;if(y.value){v.value=!0;try{const t=await na({trade_no:u,method:y.value});if(t.type===-1){M.success(_("dashboard.order.paySuccess")),b.push({name:"PaymentSuccess",query:{trade_no:u,plan_name:(e=d.value.plan)==null?void 0:e.name,amount:d.value.total_amount}});return}if(t.type===0||t.data&&(t.data.startsWith("http://")||t.data.startsWith("https://"))){window.location.href=t.data;return}p.value={type:t.type,data:t.data},$.value=!0,L()}catch{}finally{v.value=!1}}},L=()=>{T.value=!0,w=setInterval(async()=>{var e;try{const t=await da({trade_no:u});(t.data===1||t.data===3)&&(S(),$.value=!1,M.success(_("dashboard.order.paySuccess")),b.push({name:"PaymentSuccess",query:{trade_no:u,plan_name:(e=d.value.plan)==null?void 0:e.name,amount:d.value.total_amount}}))}catch{}},3e3)},S=()=>{w&&(clearInterval(w),w=null),T.value=!1},U=async()=>{try{await N({trade_no:u}),M.success(_("dashboard.orders.cancelledMessage")),b.push("/plans")}catch{}},E=async()=>{if(m.value){g.value=!0;try{await ta({code:m.value,plan_id:d.value.plan_id,period:d.value.period}),await N({trade_no:u});const e=await oa({plan_id:d.value.plan_id,period:d.value.period,coupon_code:m.value});e.data&&(M.success(_("dashboard.order.couponApplied","优惠码已应用")),b.push({path:"/order",query:{trade_no:e.data}}).then(()=>{window.location.reload()}))}catch{}finally{g.value=!1}}};return J(()=>{S()}),(e,t)=>{var O;const f=B("a-spin"),z=B("a-modal");return n(),l("div",pa,[a("div",ha,[a("div",_a,[h(c(ra),{size:32})]),a("h1",null,s(e.$t("dashboard.order.title")),1),a("p",null,s(e.$t("dashboard.order.description")),1)]),!k.value&&d.value?(n(),l("div",va,[a("div",ya,[a("div",ma,[a("div",fa,[a("h3",null,s(e.$t("dashboard.order.detailTitle")),1),a("span",ba,"#"+s(d.value.trade_no),1)]),a("div",ka,[a("div",ga,[a("div",Ca,[a("span",$a,s((O=d.value.plan)==null?void 0:O.name),1),a("span",wa,s(D(d.value.period)),1)]),a("div",za,"¥"+s((d.value.total_amount/100).toFixed(2)),1)])]),d.value.coupon_id?i("",!0):(n(),l("div",Ma,[a("div",Pa,[K(a("input",{type:"text","onUpdate:modelValue":t[0]||(t[0]=o=>m.value=o),placeholder:e.$t("dashboard.order.couponPlaceholder"),class:"coupon-input",disabled:g.value},null,8,Ta),[[X,m.value]]),a("button",{class:"apply-coupon-btn",onClick:E,disabled:!m.value||g.value},[g.value?(n(),q(c(F),{key:0,class:"animate-spin",size:16})):i("",!0),a("span",null,s(e.$t("dashboard.order.applyCoupon")),1)],8,Sa)])])),d.value.coupon_id?(n(),l("div",qa,[a("div",Fa,[h(c(ua),{size:16}),a("span",null,s(e.$t("dashboard.order.coupon")),1)]),a("div",Oa,"-¥"+s((d.value.discount_amount/100).toFixed(2)),1)])):i("",!0),a("div",Ia,[a("span",null,s(e.$t("dashboard.order.total")),1),a("span",Ra,"¥"+s((d.value.total_amount/100).toFixed(2)),1)])]),a("div",Aa,[a("div",Ba,[a("h3",null,s(e.$t("dashboard.order.paymentTitle")),1)]),a("div",Na,[(n(!0),l(R,null,A(C.value,o=>(n(),l("div",{key:o.id,class:x(["payment-item",{active:y.value===o.id}]),onClick:I=>y.value=o.id},[a("div",Wa,[o.icon?(n(),l("img",{key:0,src:o.icon,alt:"icon"},null,8,Da)):(n(),q(c(ia),{key:1,size:24}))]),a("div",ja,[a("span",La,s(o.name),1),o.handling_fee_percent||o.handling_fee_fixed?(n(),l("span",Ua,s(e.$t("dashboard.order.fee"))+": "+s(o.handling_fee_percent?o.handling_fee_percent+"%":"")+" "+s(o.handling_fee_fixed?"¥"+(o.handling_fee_fixed/100).toFixed(2):""),1)):i("",!0)]),t[3]||(t[3]=a("div",{class:"check-mark"},[a("div",{class:"outer"},[a("div",{class:"inner"})])],-1))],10,Va))),128))]),a("div",Ea,[a("button",{class:"pay-btn",disabled:!y.value||v.value,onClick:j},[v.value?(n(),q(c(F),{key:0,class:"animate-spin",size:20})):i("",!0),v.value?(n(),l("span",Qa,s(e.$t("dashboard.order.paying")),1)):(n(),l("span",Ga,s(e.$t("dashboard.order.payNow")),1))],8,Ha),a("button",{class:"cancel-btn",onClick:U,disabled:v.value},s(e.$t("dashboard.order.cancel")),9,Ja)])])]),a("div",Ka,[a("div",Xa,[a("div",Ya,[h(c(ca),{size:18}),a("h3",null,s(e.$t("dashboard.order.tipsTitle")),1)]),a("ul",Za,[(n(!0),l(R,null,A(e.$tm("dashboard.order.tips"),(o,I)=>(n(),l("li",{key:I},s(o),1))),128))])])])])):i("",!0),k.value?(n(),l("div",xa,[h(f,{size:"large"}),a("p",null,s(e.$t("common.loading")),1)])):i("",!0),!k.value&&!d.value?(n(),l("div",ae,[t[4]||(t[4]=a("div",{class:"error-icon"},"⚠️",-1)),a("p",null,s(P.value||e.$t("dashboard.order.notFound")),1),a("button",{class:"back-link",onClick:t[1]||(t[1]=o=>c(b).push("/plans"))},s(e.$t("dashboard.plans.title")),1)])):i("",!0),h(z,{visible:$.value,"onUpdate:visible":t[2]||(t[2]=o=>$.value=o),footer:null,closable:!T.value,onCancel:S,centered:"",class:"pay-modal"},{default:Z(()=>{var o;return[a("div",ee,[a("h3",null,s(e.$t("dashboard.order.scanTitle")),1),a("div",se,[p.value.type===1?(n(),l("div",te,[a("div",oe,[h(c(aa),{value:p.value.data,size:200,color:"#3b82f6"},null,8,["value"])]),(o=p.value.data)!=null&&o.startsWith("http")?(n(),l("div",ne,[a("p",de,s(e.$t("dashboard.order.cannotScanTip")),1),a("a",{href:p.value.data,target:"_blank",class:"pay-link-btn"},s(e.$t("dashboard.order.goToPay")),9,le)])):i("",!0)])):p.value.type===0?(n(),l("div",re,[a("p",null,s(e.$t("dashboard.order.jumpPay")),1),a("a",{href:p.value.data,target:"_blank",class:"pay-link-btn"},s(e.$t("dashboard.order.goToPay")),9,ie)])):i("",!0)]),a("div",ce,[h(c(F),{class:"animate-spin",size:16}),a("span",null,s(e.$t("dashboard.order.waiting")),1)])])]}),_:1},8,["visible","closable"])])}}},ge=la(ue,[["__scopeId","data-v-9cfea4af"]]);export{ge as default};
